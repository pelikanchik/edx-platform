<%inherit file="base.html" />
<%!
  import logging
  from xmodule.util.date_utils import get_default_time_display, almost_same_datetime
  from django.utils.translation import ugettext as _
  from django.core.urlresolvers import reverse
%>
<%block name="title">${_("CMS Subsection")}</%block>
<%block name="bodyclass">is-signedin course view-subsection</%block>

<%namespace name="units" file="widgets/units.html" />
<%namespace name='static' file='static_content.html'/>

<%block name="content">


    <!---
    <script type="text/javascript"
            src='${static.url("js/graph/strathausen-dracula-a6a5fa7/js/eve.js")}'>
            </script>
            --->
    <script type="text/javascript"
            src='${static.url("js/graph/strathausen-dracula-a6a5fa7/js/raphael-min.js")}'>
            </script>
    <script type="text/javascript"
            src='${static.url("js/graph/strathausen-dracula-a6a5fa7/js/g.raphael.js")}'>
            </script>
    <script type="text/javascript"
            src='${static.url("js/graph/strathausen-dracula-a6a5fa7/js/jquery-1.4.2.min.js")}'></script>

    <script type="text/javascript"
            src='${static.url("js/graph/graph.js" )}'></script>

    <script type="text/javascript"
            src='${static.url("js/graph/strathausen-dracula-a6a5fa7/js/dracula_graffle.js")}'>
            </script>

    <script type="text/javascript"
            src='${static.url("js/graph/strathausen-dracula-a6a5fa7/js/dracula_graph.js")}'></script>

    <script type="text/javascript"
            src='${static.url("js/fancybox/source/jquery.fancybox.pack.js")}'>
            </script>
    <link rel="stylesheet"
          href='${static.url("js/fancybox/source/jquery.fancybox.css")}'
          type="text/css" media="screen" />
    <link rel="stylesheet"
          href='${static.url("js/vendor/jquery-ui-1.10.3.custom/css/smoothness/jquery-ui-1.10.3.custom.css")}'
          type="text/css" media="screen" />
        <!---
            jQuery UI 1.10.3 has a bug when dragging makes dialog window jump to the bottom of screen.
            So it is advisable to use version 1.10.2 before it is fixed.
         --->
    <script type="text/javascript"
            src='${static.url("js/graph/graph_NodeRender.js" )}'></script>
    <script type="text/javascript"
            src='${static.url("js/graph/graph_NodeDetails.js" )}'></script>
    <script>


          require(['jquery', 'gettext'], function($, gettext) {


              options = '${options|h}'.replace(/\&#34;/g, '"');
              splitters_unfiltered = '${splitters|h}'.replace(/\&#34;/g, '"');
              names_string = '${names_string|h}'.replace(/\&#34;/g, '"');
              data_string = '${data_string|h}'.replace(/\&#34;/g, '"');
              graph_string = '${graph_string|h}'.replace(/\&#34;/g, '"');
              states_string = '${states|h}'.replace(/\&#34;/g, '"');
                options = options.replace(/\\\(/g,'');
                options = options.replace(/\\\)/g,'');

              options = $.parseJSON(options);
              splitters_unfiltered = $.parseJSON(splitters_unfiltered);
              names_obj = $.parseJSON(names_string);
              data_obj = $.parseJSON(data_string);
              edges_arr = $.parseJSON(graph_string);
              console.log(states_string);
              states_obj = $.parseJSON(states_string);


              splitters_unfiltered = [
                    {id:"score_rel",    parent_id:"",   title:gettext("Score (relative, %)")},
                    {id:"score_abs",    parent_id:"",   title:gettext("Score (absolute)")
              }].concat(splitters_unfiltered);

              options = [
                    {id:"less",         parent_id:"score_rel",   title:gettext("less")},
                    {id:"less-equals",  parent_id:"score_rel",   title:gettext("less or equals")},
                    {id:"equals",       parent_id:"score_rel",   title:gettext("equals")},
                    {id:"more-equals",  parent_id:"score_rel",   title:gettext("more or equals")},
                    {id:"more",         parent_id:"score_rel",   title:gettext("more")},
                    {id:"less",         parent_id:"score_abs",   title:gettext("less")},
                    {id:"less-equals",  parent_id:"score_abs",   title:gettext("less or equals")},
                    {id:"equals",       parent_id:"score_abs",   title:gettext("equals")},
                    {id:"more-equals",  parent_id:"score_abs",   title:gettext("more or equals")},
                    {id:"more",         parent_id:"score_abs",   title:gettext("more")}
              ].concat(options);

              splitters = [];

              $.each(splitters_unfiltered, function(id, value){

                  // Фильтрация заданий, в которых нет вариантов ответов

                  if ($.grep(options, function(e){ return e.parent_id == value.id})[0]){
                        splitters.push(value);
                  };
              });

          });

    </script>

<img id = "Delete-icon-base" style="display:none" src = '${static.url("img/Delete-icon.png")}' />

<!--- Костыль: я не умею получать тип модуля, поэтому я выдираю его, используя особенности форматирования вывода -->
<!--- Возможно, стоит добавить всем модулям нужный метод -->
<!--- (стандартная функция child.module_class не работает) -->

<!-- style="display:none" -->
<div style="display:none">

    <p class="data_string" >${data_string}</p>
    <p class="names_string">${names_string} </p>
    <p class="graph_string">${graph_string}</p>
    <p class="locators_dict">${locators_dict}</p>
    <p class="parent-location" >${subsection.location}</p>
    <p class="locator">${locator}</p>

</div>


<div style="display:none">
    <div id="rename-node" title="${_('Rename')}">
        <textarea id="node-rename-input" cols="20" rows="3" data-bind='value: value, valueUpdate: "afterkeydown"'/></textarea>
    </div>
    <div id="node-details" title="${_('Node Details')}">

        <p class = "node-name" >${_('Node Name')}</p>
        <a class="node-edit-link" href="#">${_('Open in editor')}</a>


        <hr align="center" width="auto" size="1" color="#000000" />
        <div id="node-content">
        </div>
        <hr align="center" width="auto" size="1" color="#000000" />
        <div id="node-edges-list">
            <p class = "node-edges-message"> ${_('Neighbours List')} </p>
        </div>
    </div>
    <div id="add-new-node" title="${_('Adding a new node')}">
        <input id="node-name-input" data-bind='value: value, valueUpdate: "afterkeydown"'/>
    </div>
    <div id="on-exiting-draging-mode" title="${_('Save Layout?')}">
        <p>${_('Do you want to save graphs layout?')}</p>
    </div>
    <div id="confirm-edge-deletion" title="${_('Are you sure?')}">
        <p>${_('Are you sure you want this edge removed?')}</p>
    </div>
    <div id="node-add-condition" title="${_('Direct Term')}">
        <table>

            <tbody data-bind="foreach: conjunctions">
                <tr>
                    <td>
                        <select id="input-splitter">
                        </select>
                    </td>
                    <td>

                        <select id="input-option">
                        </select>

                    </td>
                    <td>
                        <input id="input-value" class = "value" />
                    </td>
                </tr>
            </tbody>
        </table>


    </div>
</div>



<div id="canvas"></div>
<button id="redraw" onclick='redraw();'>${_("Redraw")}</button>
<!---
<button id="mode" onclick="moving_mode();">mode</button>
        --->
<button id="save" onclick="save_layout();">${_("Save")}</button>
<button id="load" onclick="load_layout();">${_("Load")}</button>

</%block>